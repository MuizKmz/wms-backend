// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- Users & Roles ---
model User {
  id              String    @id @default(uuid())
  username        String    @unique @db.VarChar(50)
  email           String    @unique @db.VarChar(100)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  fullName        String    @map("full_name") @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  roleId          String    @map("role_id")
  language        String?   @db.VarChar(10)
  profileImageUrl String?   @map("profile_image_url") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  role              Role          @relation(fields: [roleId], references: [id])
  receivingsCreated Receiving[]   @relation("CreatedBy")
  ordersCreated     Order[]       @relation("CreatedBy")
  auditLogs         AuditLog[]

  @@map("users")
}

model Role {
  id          String @id @default(uuid())
  name        String @unique @db.VarChar(50)
  permissions Json

  // Relations
  users User[]

  @@map("roles")
}

// --- Warehouses & Storage ---
model Warehouse {
  id           String    @id @default(uuid())
  warehouseCode String   @unique @map("warehouse_code") @db.VarChar(50)
  name         String    @db.VarChar(100)
  address      String?   @db.Text
  manager      String?   @db.VarChar(100)
  contactPhone String?   @map("contact_phone") @db.VarChar(20)
  email        String?   @db.VarChar(100)
  status       String    @db.VarChar(20)
  remark       String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  racks      Rack[]
  sections   Section[]
  receivings Receiving[]
  inventory  Inventory[]

  @@map("warehouses")
}

model Rack {
  id          String  @id @default(uuid())
  warehouseId String  @map("warehouse_id")
  rackCode    String  @unique @map("rack_code") @db.VarChar(50)
  rackName    String  @map("rack_name") @db.VarChar(100)
  rackType    String? @map("rack_type") @db.VarChar(50)
  capacity    Int?
  status      String  @db.VarChar(20)
  remark      String? @db.Text

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  sections  Section[]
  inventory Inventory[]

  @@map("racks")
}

model Section {
  id          String  @id @default(uuid())
  warehouseId String  @map("warehouse_id")
  rackId      String  @map("rack_id")
  sectionCode String  @unique @map("section_code") @db.VarChar(50)
  sectionName String  @map("section_name") @db.VarChar(100)
  capacity    Int?
  status      String  @db.VarChar(20)
  remark      String? @db.Text

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  rack      Rack      @relation(fields: [rackId], references: [id])
  inventory Inventory[]

  @@map("sections")
}

// --- Business Partners ---
model Supplier {
  id           String  @id @default(uuid())
  supplierCode String  @unique @map("supplier_code") @db.VarChar(50)
  supplierName String  @map("supplier_name") @db.VarChar(100)
  manager      String? @db.VarChar(100)
  contactPhone String? @map("contact_phone") @db.VarChar(20)
  email        String? @db.VarChar(100)
  status       String  @db.VarChar(20)
  remark       String? @db.Text

  // Relations
  products   Product[]
  receivings Receiving[]
  orders     Order[]

  @@map("suppliers")
}

model Customer {
  id            String  @id @default(uuid())
  customerCode  String  @unique @map("customer_code") @db.VarChar(50)
  customerName  String  @map("customer_name") @db.VarChar(100)
  contactPerson String? @map("contact_person") @db.VarChar(100)
  phone         String? @db.VarChar(20)
  email         String? @db.VarChar(100)
  address       String? @db.Text
  city          String? @db.VarChar(100)
  status        String  @db.VarChar(20)
  remark        String? @db.Text

  // Relations
  orders Order[]

  @@map("customers")
}

// --- Products & Inventory ---
model Category {
  id                  String  @id @default(uuid())
  categoryCode        String  @unique @map("category_code") @db.VarChar(50)
  name                String  @db.VarChar(100)
  parentCategoryId    String? @map("parent_category_id")
  level               Int
  storageRequirements String? @map("storage_requirements") @db.Text
  status              String  @db.VarChar(20)

  // Relations
  products Product[]

  @@map("categories")
}

model Product {
  id          String    @id @default(uuid())
  skuCode     String    @unique @map("sku_code") @db.VarChar(50)
  productCode String    @map("product_code") @db.VarChar(50)
  name        String    @db.VarChar(255)
  categoryId  String    @map("category_id")
  supplierId  String    @map("supplier_id")
  status      String    @db.VarChar(20)
  remarks     String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  category       Category            @relation(fields: [categoryId], references: [id])
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  certificates   ProductCertificate[]
  epcs           Epc[]
  receivingItems ReceivingItem[]
  orderItems     OrderItem[]
  inventory      Inventory[]

  @@map("products")
}

model ProductCertificate {
  id                 String @id @default(uuid())
  productId          String @map("product_id")
  certificateName    String @map("certificate_name") @db.VarChar(100)
  certificateFileUrl String @map("certificate_file_url") @db.VarChar(255)

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@map("product_certificates")
}

model Epc {
  id          String   @id @default(uuid())
  epcCode     String   @unique @map("epc_code") @db.VarChar(100)
  productId   String   @map("product_id")
  batchName   String?  @map("batch_name") @db.VarChar(100)
  batchNumber Int?     @map("batch_number")
  status      String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@map("epcs")
}

// --- Receiving ---
model Receiving {
  id            String    @id @default(uuid())
  receivingCode String    @unique @map("receiving_code") @db.VarChar(50)
  doNumber      String?   @map("do_number") @db.VarChar(50)
  warehouseId   String    @map("warehouse_id")
  rackId        String?   @map("rack_id")
  sectionId     String?   @map("section_id")
  source        String?   @db.VarChar(50)
  supplierId    String?   @map("supplier_id")
  receivingDate DateTime  @map("receiving_date") @db.Date
  receivedBy    String?   @map("received_by") @db.VarChar(100)
  remarks       String?   @db.Text
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])
  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  creator        User            @relation("CreatedBy", fields: [createdBy], references: [id])
  receivingItems ReceivingItem[]

  @@map("receivings")
}

model ReceivingItem {
  id          String @id @default(uuid())
  receivingId String @map("receiving_id")
  productId   String @map("product_id")
  quantity    Int
  unit        String @db.VarChar(20)

  // Relations
  receiving Receiving @relation(fields: [receivingId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@map("receiving_items")
}

// --- Orders ---
model Order {
  id                    String    @id @default(uuid())
  orderType             String    @map("order_type") @db.VarChar(10) // 'PO' or 'DO'
  orderNo               String    @unique @map("order_no") @db.VarChar(50)
  customerId            String?   @map("customer_id")
  supplierId            String?   @map("supplier_id")
  picName               String?   @map("pic_name") @db.VarChar(100)
  status                String    @db.VarChar(20)
  estimatedDeliveryTime DateTime? @map("estimated_delivery_time")
  remarks               String?   @db.Text
  createdBy             String    @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  customer   Customer?   @relation(fields: [customerId], references: [id])
  supplier   Supplier?   @relation(fields: [supplierId], references: [id])
  creator    User        @relation("CreatedBy", fields: [createdBy], references: [id])
  orderItems OrderItem[]
  shipments  Shipment[]

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")
  quantity  Int

  // Relations
  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// --- Inventory ---
model Inventory {
  id            String   @id @default(uuid())
  productId     String   @map("product_id")
  warehouseId   String   @map("warehouse_id")
  rackId        String   @map("rack_id")
  sectionId     String   @map("section_id")
  quantity      Int
  lastUpdatedAt DateTime @map("last_updated_at")

  // Relations
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  rack      Rack      @relation(fields: [rackId], references: [id])
  section   Section   @relation(fields: [sectionId], references: [id])

  @@map("inventory")
}

// --- Shipments ---
model Shipment {
  id                    String    @id @default(uuid())
  trackingCode          String    @unique @map("tracking_code") @db.VarChar(100)
  orderId               String    @map("order_id")
  carrier               String?   @db.VarChar(100)
  shippingDate          DateTime? @map("shipping_date") @db.Date
  estimatedDeliveryDate DateTime? @map("estimated_delivery_date") @db.Date
  destination           String?   @db.Text
  state                 String    @db.VarChar(50)
  remark                String?   @db.Text

  // Relations
  order Order @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

// --- Audit Logs ---
model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String   @db.VarChar(50)
  tableName String   @map("table_name") @db.VarChar(50)
  rowId     String   @map("row_id")
  diff      Json
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}